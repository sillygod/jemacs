
#+TITLE: ai.el
#+PROPERTY: header-args:emacs-lisp :tangle ./jemacs-ai.el :mkdirp yes

* setup

  #+begin_src emacs-lisp
    ;;; mycraft --- Summary  -*- lexical-binding: t; -*-
    ;;; Copyright (C) 2020 mycraft maintainers
    ;;; Author: Jing
    ;;; package --- mycraft
    ;;; Commentary:

    ;;; Code:


  #+end_src

* copilot

  #+begin_src emacs-lisp
    (use-package copilot
      :straight (:host github :repo "copilot-emacs/copilot.el" :files ("*.el"))
      :ensure t
      :config
      (defun copilot-disable-on-env ()
        "Predicate function to disable Copilot for .env files."
        (when (buffer-file-name)
          (string= (file-name-nondirectory (buffer-file-name)) ".env")))

      (add-to-list 'copilot-disable-predicates #'copilot-disable-on-env)
      (define-key copilot-mode-map (kbd "C-<return>") #'copilot-accept-completion))
  #+end_src

* gptel
  https://github.com/karthink/gptel

  #+begin_src emacs-lisp
    (defun read-prompt-from-file (file)
      "Read the content of FILE and return it as a string."
      (with-temp-buffer
        (insert-file-contents file)
        (buffer-string)))


    (use-package gptel
      :defer t
      :custom
      (gptel-prompt-prefix-alist '((markdown-mode . "### ")
                                   (org-mode . "** Prompt: ")
                                   (text-mode . "### ")))
      (gptel-response-prefix-alist  '((markdown-mode . "")
                                      (org-mode . "** Response: \n")
                                      (text-mode . "")))
      (gptel-log-level 'debug)
      (gptel-directives
       '((default . "You are a large language model living in Emacs and a helpful assistant. Respond concisely.")
         (programming . "You are a senior software engineer. Before showing the steps you followed in reaching the answer, break down questions into follow-up questions when necessary to arrive at the correct answer. Please ask me any questions you have about this so I can give you more context.")
         (devops . "You are a senior devops engineer. Before showing the steps you followed in reaching the answer, break down questions into follow-up questions when necessary to arrive at the correct answer. Please ask me any questions you have about this so I can give you more context.

    IMPORTANT: recommend best practices if the scenario is matched
    IMPORTANT: When making changes to files, first understand the file's code conventions. Mimic code style, use existing libraries and utilities, and follow existing patterns.
    ")
         (writing . "You are a professional writing assistant. Respond clearly and concisely with well-structured, grammatically correct prose. Focus on clarity and tone.")
         (chat . "You are a large language model and a conversation partner. Respond concisely.")
         ;; (debug . (lambda () (read-prompt-from-file "")))
         ))
      :config
      ;; OPTIONAL configuration
      (setq gptel-model 'devstral-medium-latest

            gptel-default-mode #'org-mode
            gptel-backend
            (gptel-make-openai "mistral"    ;Any name you want
              :host "api.mistral.ai"
              :endpoint "/v1/chat/completions"
              :protocol "https"
              :stream t
              :key mistral_api_key
              :models '("mistral-large-latest"
                        "mistral-medium-latest"
                        "codestral-latest"
                        "devstral-medium-latest"
                        "devstral-small-latest")))
      (gptel-make-openai "Groq"             ;Any name you want
        :host "api.groq.com"
        :endpoint "/openai/v1/chat/completions"
        :stream t
        :key groq_api_key          ;can be a function that returns the key
        :models '("meta-llama/llama-3.3-70b-versatile"
                  "meta-llama/llama-4-maverick-17b-128e-instruct"
                  "deepseek-r1-distill-llama-70b"
                  "qwen-qwq-32b"))

      (require 'gptel-integrations)
      (macher-install)

      ;; (transient-suffix-put 'gptel-menu (kbd "RET") :key "C-<return>")

      (defun get-staged-diff ()
        "Get the diff of staged files in the current Git repository."
        (string-trim
         (shell-command-to-string "git diff --cached")))

      (defun gptel-commit-message ()
        "Insert a generated commit message at point using GPT."
        (interactive)
        (let ((diff (get-staged-diff)))
          (gptel-request
              (format "Generate a Git commit message using the following format:

    [<type>] <summary>

    <BLANK LINE>
    - <change 1>
    - <change 2>
    ...

    Diff content is: %s

    Requirements:
    1. The message must be clear and concise and do not use ``` to enclose the response
    2. The prefix (type) must be exactly one of the following:
       - [feat] for new features
       - [fix] for bug fixes
       - [ref] for code refactoring (no behavior change)
       - [perf] for performance tuning
       - [ci] for ci cd adjustment
    3. The summary (first line) must:
       - Use imperative mood (e.g.,  add ,  fix ,  update )
       - Be a single line, no more than 50 characters
       - Avoid punctuation at the end
    4. Insert **exactly one blank line** between the summary and the details.
    5. The detailed changes should:
       - Be listed using bullet points (`- `)
       - Be short and action-based (describe what was done, not why)
       - Use consistent verb tense (imperative or past tense, choose one)

    Example output:

    [fix] handle null error in login flow

    - add null check to login service
    - update error handling for auth module
    - add test for edge case with empty username

          " diff)
            :stream t)))

      ;; create some tools below
      (gptel-make-tool
       :function (lambda (filepath)
                   (with-temp-buffer
                     (insert-file-contents (expand-file-name filepath))
                     (buffer-string)))
       :name "read_file"
       :description "Read and display the contents of a file"
       :args (list '(:name "filepath"
                           :type string
                           :description "Path to the file to read. Supports relative paths and ~."))
       :category "filesystem")

      (gptel-make-tool
       :function (lambda (directory)
                   (mapconcat #'identity
                              (directory-files directory)
                              "\n"))
       :name "list_directory"
       :description "List the contents of a given directory"
       :args (list '(:name "directory"
                           :type string
                           :description "The path to the directory to list"))
       :category "filesystem")

      (gptel-make-tool
       :function (lambda (parent name)
                   (condition-case nil
                       (progn
                         (make-directory (expand-file-name name parent) t)
                         (format "Directory %s created/verified in %s" name parent))
                     (error (format "Error creating directory %s in %s" name parent))))
       :name "make_directory"
       :confi t
       :description "Create a new directory with the given name in the specified parent directory"
       :args (list '(:name "parent"
                           :type string
                           :description "The parent directory where the new directory should be created, e.g. /tmp")
                   '(:name "name"
                           :type string
                           :description "The name of the new directory to create, e.g. testdir"))
       :category "filesystem")

      (gptel-make-tool
       :function (lambda (path filename content)
                   (let ((full-path (expand-file-name filename path)))
                     (with-temp-buffer
                       (insert content)
                       (write-file full-path))
                     (format "Created file %s in %s" filename path)))
       :name "create_file"
       :confirm t
       :description "Create a new file with the specified content"
       :args (list '(:name "path"
                           :type string
                           :description "The directory where to create the file")
                   '(:name "filename"
                           :type string
                           :description "The name of the file to create")
                   '(:name "content"
                           :type string
                           :description "The content to write to the file"))
       :category "filesystem")

      (defun gptel-read-documentation (symbol)
        "Read the documentation for SYMBOL, which can be a function or variable."
        (let ((sym (intern symbol)))
          (cond
           ((fboundp sym)
            (documentation sym))
           ((boundp sym)
            (documentation-property sym 'variable-documentation))
           (t
            (format "No documentation found for %s" symbol)))))

      (gptel-make-tool
       :name "read_documentation"
       :function #'gptel-read-documentation
       :description "Read the documentation for a given function or variable"
       :args (list '(:name "name"
                           :type string
                           :description "The name of the function or variable whose documentation is to be retrieved"))
       :category "emacs")

      (defun gptel-youtube-metadata (callback url)
        (let* ((video-id (and (string-match (concat
                                             "^\\(?:http\\(?:s?://\\)\\)?\\(?:www\\.\\)?\\(?:youtu\\(?:\\(?:\\.be\\|be\\.com\\)/\\)\\)"
                                             "\\(?:watch\\?v=\\)?"
                                             "\\([^?&]+\\)")
                                            url)
                              (match-string 1 url)))
               (dir (file-name-concat temporary-file-directory "yt-dlp" video-id)))
          (if (file-directory-p dir)
              (delete-directory dir t))
          (make-directory dir t)
          (let ((default-directory dir)
                (idx 0)
                (data (list :description nil :transcript nil)))
            (make-process :name "yt-dlp"
                          :command `("yt-dlp" "--write-description" "--skip-download" "--output" "video" ,url)
                          :sentinel (lambda (proc status)
                                      (cl-incf idx)
                                      (let ((default-directory dir))
                                        (when (file-readable-p "video.description")
                                          (plist-put data :description
                                                     (with-temp-buffer
                                                       (insert-file-contents "video.description")
                                                       (buffer-string)))))
                                      (when (= idx 2)
                                        (funcall callback (gptel--json-encode data))
                                        (delete-directory dir t))))
            (make-process :name "yt-dlp"
                          :command `("yt-dlp" "--skip-download" "--write-auto-subs" "--sub-langs" "en,-live_chat" "--convert-subs" "srt" "--output" "video" ,url)
                          :sentinel (lambda (proc status)
                                      (cl-incf idx)
                                      (let ((default-directory dir))
                                        (when (file-readable-p "video.en.srt")
                                          (plist-put data :transcript
                                                     (with-temp-buffer
                                                       (insert-file-contents "video.en.srt")
                                                       (buffer-string)))))
                                      (when (= idx 2)
                                        (funcall callback (gptel--json-encode data))
                                        (delete-directory dir t)))))))

      (gptel-make-tool
       :name "youtube_video_metadata"
       :function #'gptel-youtube-metadata
       :confirm t
       :description "Find the description and video transcript for a youtube video. Return a JSON object containing two fields:

    \"description\": The video description added by the uploader
    \"transcript\": The video transcript in SRT format"
       :args '((:name "url"
                      :description "The youtube video URL, for example \"https://www.youtube.com/watch?v=H2qJRnV8ZGA\""
                      :type string))
       :category "web"
       :async t
       :include t)

      ;; https://github.com/yt-dlp/yt-dlp/wiki/Installation
      )
  #+end_src

  https://github.com/kmontag/macher

  #+begin_src emacs-lisp
    (use-package macher
      :defer t
      :straight
      (:host github :repo "kmontag/macher")

      :custom
      ;; The org UI has structured navigation and nice content folding.
      (macher-action-buffer-ui 'org)

      :config
      ;; Adjust buffer positioning to taste.
      ;; (add-to-list
      ;;  'display-buffer-alist
      ;;  '("\\*macher:.*\\*"
      ;;    (display-buffer-in-side-window)
      ;;    (side . bottom)))
      ;; (add-to-list
      ;;  'display-buffer-alist
      ;;  '("\\*macher-patch:.*\\*"
      ;;    (display-buffer-in-side-window)
      ;;    (side . right)))
      )

  #+end_src

* gemini cli

  #+begin_src emacs-lisp
    (use-package gemini-cli
      :straight (:type git :host github :repo "linchen2chris/gemini-cli.el" :branch "main"
                       :files ("*.el" (:exclude "demo.gif")))
      :bind-keymap
      ("C-c c" . gemini-cli-command-map)
      :config
      (setq gemini-cli-terminal-backend 'vterm)
      (add-hook 'gemini-cli-start-hook
                (lambda ()
                  ;; Only increase scrollback for vterm backend
                  (when (eq gemini-cli-terminal-backend 'vterm)
                    (setq-local vterm-max-scrollback 5000))))
      (gemini-cli-mode)
      (add-to-list 'display-buffer-alist
                   '("^\\*gemini"
                     (display-buffer-in-side-window)
                     (side . right)
                     (window-width . 130))))
  #+end_src

* claude code

  #+begin_src emacs-lisp
    (use-package claude-code-ide
      :straight (:type git :host github :repo "manzaltu/claude-code-ide.el")
      :config
      (claude-code-ide-emacs-tools-setup))
  #+end_src

* goose cli
  https://github.com/aq2bq/goose.el
  export OPENAI_HOST="https://api.mistral.ai"
  export OPENAI_API_KEY="â€¦"

* mcp

  #+begin_src emacs-lisp
    (use-package mcp
      :defer t
      :straight (:host github :repo "lizqwerscott/mcp.el" :files ("*.el"))
      :after gptel
      :custom (mcp-hub-servers
               `(("fetch" . (:command "uvx" :args ("mcp-server-fetch")))
                 ("context7" . (:command "npx" :args ("-y" "@upstash/context7-mcp")))
                 ("serena" . (:command "uvx" :args ("--from" "git+https://github.com/oraios/serena" "serena-mcp-server" "--context" "ide-assistant")))))
      ;; ("graphlit" . (
      ;;                :command "npx"
      ;;                :args ("-y" "graphlit-mcp-server")
      ;;                :env (
      ;;                      :GRAPHLIT_ORGANIZATION_ID "your-organization-id"
      ;;                      :GRAPHLIT_ENVIRONMENT_ID "your-environment-id"
      ;;                      :GRAPHLIT_JWT_SECRET "your-jwt-secret")))))
      :config (require 'mcp-hub))
  #+end_src
* minuet-ai

  currently, not take into consideration
* emacs ellama (AI tool like chatgpt)
  https://github.com/s-kostyaev/ellama

  #+begin_src emacs-lisp
    (use-package ellama
      :straight
      (:host github :repo "s-kostyaev/ellama" :files ("*.el"))
      :init
      (require 'llm-ollama)
      (setopt ellama-provider
              (make-llm-ollama
               :chat-model "zephyr" :embedding-model "zephyr")))
  #+end_src
* aider chat

  #+begin_src emacs-lisp
    (use-package aider
      :defer t
      :config
      ;; Use claude-3-5-sonnet cause it is best in aider benchmark
      (setq aider-args '("--model" "mistral/devstral-medium-latest"))
      (setenv "MISTRAL_API_KEY" mistral_api_key)
      ;; Or use gemini v2 model since it is very good and free
      ;; (setq aider-args '("--model" "gemini/gemini-exp-1206"))
      ;; (setenv "GEMINI_API_KEY" <your-gemini-api-key>)
      ;; Or use your personal config file
      ;; (setq aider-args `("--config" ,(expand-file-name "~/.aider.conf.yml")))
      ;; ;;
      ;; Optional: Set a key binding for the transient menu
      )
  #+end_src

  now, use this implementation instead
  https://github.com/MatthewZMD/aidermacs

  #+begin_src emacs-lisp :tangle no
    (use-package aidermacs
      :bind (("C-c a" . aidermacs-transient-menu))
      :config
      ; Set API_KEY in .bashrc, that will automatically picked up by aider or in elisp
      (setenv "MISTRAL_API_KEY" mistral_api_key)
      :custom
      ; See the Configuration section below
      (aidermacs-use-architect-mode t)
      (aidermacs-default-model "mistral/mistral-large-latest"))
  #+end_src

* provide package

  #+begin_src emacs-lisp
    (provide 'jemacs-ai)
    ;;; jemacs-ai.el ends here
  #+end_src
